<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Todos • PIM</title>
  <style>
    :root { --bg:#0a0a0a; --card-bg:#1a1a1a; --text:#f5f5f5; --accent:#fff; }
    body { background:var(--bg); color:var(--text); font:15px system-ui; margin:0; padding:20px; }
    h1 { margin-bottom:20px; }
    .bar { display:flex; gap:10px; }
    .todo-input, .desc-input, .date-input, .prio-input {
      padding:10px; border-radius:8px; border:none; background:#222; color:var(--text);
    }
    .todo-input { flex:1; }
    .add-btn { padding:10px 14px; border:none; border-radius:8px; background:var(--accent); color:#000; cursor:pointer; }
    ul { list-style:none; padding:0; margin-top:20px; }
    li { background:var(--card-bg); padding:10px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    li.done { text-decoration: line-through; opacity:0.6; }
    .back { margin-top:20px; padding:10px 14px; background:#222; border:none; border-radius:8px; color:var(--text); cursor:pointer; }
    .actions button { margin-left:8px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Todo List</h1>
  <div class="bar">
    <input id="todoInput" class="todo-input" placeholder="New task title..." />
    <input id="descInput" class="desc-input" placeholder="Description (optional)" />
    <input id="dueInput" class="date-input" type="date" />
    <select id="prioInput" class="prio-input">
      <option value="normal">normal</option>
      <option value="low">low</option>
      <option value="high">high</option>
    </select>
    <button id="addBtn" class="add-btn">Add</button>
  </div>
  <ul id="todoList"></ul>
  <button class="back" onclick="window.location.href='dashboard.html'">← Back</button>

  <script>
    const API_BASE = location.hostname.includes("localhost") ? "http://127.0.0.1:8000" : "https://pim-app-final.onrender.com";
    const sessionId = localStorage.getItem("sessionId");
    if (!sessionId) { location.href = "login.html"; }
    const auth = { "Authorization": "Bearer " + sessionId, "Content-Type": "application/json" };

    const todoList = document.getElementById("todoList");

    async function loadTodos() {
      const res = await fetch(`${API_BASE}/todos`, { headers: { "Authorization": auth.Authorization } });
      const payload = await res.json();
      todoList.innerHTML = "";
      const items = payload.data?.todos || [];
      items.forEach(renderTodo);
    }

    function renderTodo(t) {
      const li = document.createElement("li");
      if (t.completed) li.classList.add("done");
      li.innerHTML = `
        <div>
          <strong>${t.title}</strong>
          <div style="font-size:12px;opacity:.8">
            Priority: ${t.priority} • Due: ${t.due_date || "—"} ${t.note_title ? "• Note: " + t.note_title : ""}
          </div>
        </div>
        <div class="actions">
          <button onclick="toggleTodo(${t.id})">✔</button>
          <button onclick="deleteTodo(${t.id})">✖</button>
        </div>`;
      todoList.appendChild(li);
    }

    async function addTodo() {
      const title = document.getElementById("todoInput").value.trim();
      const description = document.getElementById("descInput").value.trim();
      const due_date = document.getElementById("dueInput").value || null;
      const priority = document.getElementById("prioInput").value;
      if (!title) return;
      await fetch(`${API_BASE}/todos`, {
        method: "POST",
        headers: auth,
        body: JSON.stringify({ title, description, due_date, priority })
      });
      document.getElementById("todoInput").value = "";
      document.getElementById("descInput").value = "";
      document.getElementById("dueInput").value = "";
      document.getElementById("prioInput").value = "normal";
      loadTodos();
    }

    async function toggleTodo(id) {
      await fetch(`${API_BASE}/todos/${id}/toggle`, { method: "PATCH", headers: { "Authorization": auth.Authorization } });
      loadTodos();
    }

    async function deleteTodo(id) {
      await fetch(`${API_BASE}/todos/${id}`, { method: "DELETE", headers: { "Authorization": auth.Authorization } });
      loadTodos();
    }

    document.getElementById("addBtn").addEventListener("click", addTodo);
    loadTodos();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Folders • PIM</title>
  <style>
    :root{--bg:#0a0a0a;--card:#111;--ink:#f5f5f5;--muted:#bdbdbd;--line:#2a2a2a;--chip:#1e1e1e;--chip-border:#3a3a3a}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .top{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .back{color:var(--muted);text-decoration:none;padding:6px 10px;border:1px solid #333;border-radius:8px}
    .back:hover{background:#121212}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.5)}
    .node{margin-left:14px;border-left:1px dashed var(--line);padding-left:10px}
    .row{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px}
    .row:hover{background:#171717}
    .caret{width:16px;text-align:center;color:#aaa;cursor:pointer}
    .name{font-weight:600}
    .kids{margin-top:6px}
    .notes{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0 24px}
    .chip{padding:6px 8px;border:1px solid var(--chip-border);background:var(--chip);border-radius:999px;font-size:13px;cursor:grab}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="dashboard.html">← Back</a>
      <h1>Folder Structure</h1>
    </div>
    <div class="card" id="tree"></div>
  </div>

  <script>
    const API_BASE = location.hostname.includes('localhost') ? 'http://127.0.0.1:8000' : 'https://pim-app-final.onrender.com';
    const sessionId = localStorage.getItem('sessionId'); if(!sessionId) location.href='login.html';
    const username = localStorage.getItem('username') || 'guest';
    const FOLDERS_KEY = `${username}_foldersTree`;
    const NOTE_FOLDER_KEY = `${username}_noteFolders`;

    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
    function loadTree(){ return JSON.parse(localStorage.getItem(FOLDERS_KEY) || '[]'); }
    function ensureIds(tree){ tree.forEach(n=>{ if(!n.id) n.id=uid(); n.children = n.children||[]; ensureIds(n.children); }); return tree; }
    async function fetchNotes(){
      const res = await fetch(`${API_BASE}/notes`, { headers:{ Authorization:`Bearer ${sessionId}` }});
      if(!res.ok) return []; const data=await res.json(); return data?.data?.notes||[];
    }

    function render(){
      const t = document.getElementById('tree');
      t.innerHTML='';
      const raw = ensureIds(loadTree());
      const map = JSON.parse(localStorage.getItem(NOTE_FOLDER_KEY) || '{}');

      fetchNotes().then(notes=>{
        raw.forEach(n=> t.appendChild(renderNode(n, notes, map)));
      });
    }

    function renderNode(node, notes, map){
      const wrap = document.createElement('div'); wrap.className='node';
      const row = document.createElement('div'); row.className='row';
      const caret = document.createElement('div'); caret.className='caret'; caret.textContent = node.children?.length ? '▾' : '•';
      const name = document.createElement('div'); name.className='name'; name.textContent = node.name;
      row.append(caret, name); wrap.appendChild(row);

      const kids = document.createElement('div'); kids.className='kids'; wrap.appendChild(kids);
      const chips = document.createElement('div'); chips.className='notes'; wrap.appendChild(chips);

      function refresh(){
        // children
        kids.innerHTML='';
        node.children?.forEach(ch=> kids.appendChild(renderNode(ch, notes, map)));
        // notes mapped to this folder
        chips.innerHTML='';
        notes.filter(n=> map[n.title]===node.id).forEach(n=>{
          const c = document.createElement('div'); c.className='chip'; c.textContent = n.title;
          c.draggable = true;
          c.ondragstart = e=> e.dataTransfer.setData('text/plain', n.title);
          chips.appendChild(c);
        });
      }
      refresh();

      // drop target
      row.ondragover = e=> e.preventDefault();
      row.ondrop = e=>{
        e.preventDefault();
        const title = e.dataTransfer.getData('text/plain'); if(!title) return;
        const m = JSON.parse(localStorage.getItem(NOTE_FOLDER_KEY) || '{}');
        m[title] = node.id; localStorage.setItem(NOTE_FOLDER_KEY, JSON.stringify(m));
        render();
      };

      // expand/collapse
      let expanded = true;
      caret.onclick = ()=>{
        if(!node.children?.length){ return; }
        expanded = !expanded;
        kids.style.display = expanded ? 'block':'none';
        caret.textContent = expanded ? '▾':'▸';
      };

      // rename on dblclick
      name.ondblclick = ()=>{
        const old = node.name;
        const input = document.createElement('input'); input.value = old; input.style.width='60%';
        name.replaceChildren(input); input.focus();
        const finish=(commit)=>{
          const val = input.value.trim();
          node.name = commit ? (val||old) : old;
          saveTree(); render();
        };
        input.onkeydown = e=>{ if(e.key==='Enter') finish(true); if(e.key==='Escape') finish(false); };
        input.onblur = ()=> finish(true);
      };

      return wrap;
    }

    function saveTree(){
      const raw = ensureIds(loadTree());
      localStorage.setItem(FOLDERS_KEY, JSON.stringify(raw));
    }

    render();
  </script>
</body>
</html>

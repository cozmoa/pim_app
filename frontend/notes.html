<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Notes • PIM</title>
  <style>
    :root{--bg:#0a0a0a;--card:#111;--ink:#f5f5f5;--muted:#bdbdbd;--field:#1f1f1f;--border:#333;--accent:#fff;--accent-ink:#000}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .top{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .back{color:var(--muted);text-decoration:none;padding:6px 10px;border:1px solid var(--border);border-radius:8px}
    .back:hover{background:#121212}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.5)}
    .list{display:grid;gap:10px}
    .note{display:grid;grid-template-columns:1fr 220px 170px;gap:10px;align-items:center;background:#151515;border:1px solid #2d2d2d;border-radius:10px;padding:12px}
    .title{font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    select,input,textarea{background:var(--field);border:1px solid var(--border);color:var(--ink);border-radius:8px;padding:8px 10px}
    .btn{padding:8px 10px;border:1px solid rgba(255,255,255,.5);background:var(--accent);color:var(--accent-ink);border-radius:8px;font-weight:700;cursor:pointer}
    .btn.warn{background:#2a2a2a;color:#eee}
    .row{display:flex;gap:8px;justify-content:flex-end}
    .empty{padding:14px;color:var(--muted)}
    .searchBar{margin:10px 0;width:100%;padding:10px;background:#1a1a1a;border:1px solid #333;border-radius:10px;color:var(--ink)}
    dialog{border:none;border-radius:12px;background:#141414;color:var(--ink);padding:20px;border:1px solid #333;width:90%;max-width:900px}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .grid2{display:grid;gap:12px}
    .big-input{width:100%;padding:10px;font-size:16px;border-radius:8px}
    textarea.big{min-height:260px;resize:vertical;width:100%;font-size:15px}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{background:#222;padding:6px 10px;border-radius:6px;font-size:13px}
    .tag-input{flex:1;min-width:120px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="dashboard.html">← Back</a>
      <h1>Notes</h1>
    </div>

    <input id="search" class="searchBar" placeholder="Search notes by title, content, or tags…"/>

    <div class="card">
      <div id="notes" class="list"></div>
      <div id="empty" class="empty" style="display:none;">No notes yet. Create one from the dashboard.</div>
    </div>
  </div>

  <dialog id="editDlg">
    <form method="dialog" class="grid2">
      <h2>Edit Note</h2>
      <input id="editTitle" class="big-input" placeholder="Note title"/>
      <textarea id="editBody" class="big" placeholder="Note content..."></textarea>
      <div>
        <label>Tags</label>
        <input id="editTags" class="big-input" placeholder="Comma separated (e.g., work, urgent)"/>
      </div>
      <div class="row">
        <button class="btn warn" value="cancel">Cancel</button>
        <button class="btn" value="ok">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    const API_BASE = location.hostname.includes('localhost') ? 'http://127.0.0.1:8000' : 'https://pim-app-final.onrender.com';
    const sessionId = localStorage.getItem('sessionId'); if(!sessionId) location.href='login.html';
    const username = localStorage.getItem('username') || 'guest';
    const NOTE_FOLDER_KEY = `${username}_noteFolders`;
    const TAGS_KEY = `${username}_noteTags`;

    const notesEl=document.getElementById('notes');
    const emptyEl=document.getElementById('empty');
    const searchEl=document.getElementById('search');
    const editDlg=document.getElementById('editDlg');
    const editTitle=document.getElementById('editTitle');
    const editBody=document.getElementById('editBody');
    const editTags=document.getElementById('editTags');

    let allNotes=[], editingOriginalTitle=null;

    async function loadNotes(){
      const res=await fetch(`${API_BASE}/notes`,{headers:{Authorization:`Bearer ${sessionId}`}});
      const data=await res.json().catch(()=> ({}));
      allNotes=res.ok?(data?.data?.notes||[]):[];
      render();
    }

    function render(filter=''){
      notesEl.innerHTML='';
      const tagMap=JSON.parse(localStorage.getItem(TAGS_KEY)||'{}');
      const map=JSON.parse(localStorage.getItem(NOTE_FOLDER_KEY)||'{}');

      const notes=filter
        ? allNotes.filter(n=>
            n.title.toLowerCase().includes(filter) ||
            (n.content||'').toLowerCase().includes(filter) ||
            (tagMap[n.title]||[]).join(',').toLowerCase().includes(filter)
          )
        : allNotes;

      if(!notes.length){ emptyEl.style.display='block'; return; }
      emptyEl.style.display='none';

      for(const n of notes){
        const row=document.createElement('div'); row.className='note';
        const left=document.createElement('div');
        const tags=(tagMap[n.title]||[]).map(t=>`<span class="tag">${t}</span>`).join('');
        left.innerHTML=`<div class="title">${n.title}</div>
          <div class="muted">Updated: ${n.modified_at}</div>
          <div class="tags">${tags}</div>`;

        const folderSel=document.createElement('select');
        folderSel.innerHTML=`<option value="">— No folder —</option>`;
        if(map[n.title]) folderSel.value=map[n.title];
        folderSel.onchange=()=>{
          const m=JSON.parse(localStorage.getItem(NOTE_FOLDER_KEY)||'{}');
          if(folderSel.value) m[n.title]=folderSel.value; else delete m[n.title];
          localStorage.setItem(NOTE_FOLDER_KEY,JSON.stringify(m));
        };

        const actions=document.createElement('div'); actions.className='row';
        const btnEdit=document.createElement('button'); btnEdit.className='btn'; btnEdit.textContent='Edit'; btnEdit.onclick=()=>openEdit(n,tagMap[n.title]||[]);
        const btnDel=document.createElement('button'); btnDel.className='btn warn'; btnDel.textContent='Delete'; btnDel.onclick=()=>delNote(n.title);

        actions.append(btnEdit,btnDel);
        row.append(left,folderSel,actions);
        notesEl.appendChild(row);
      }
    }

    function openEdit(n,tags=[]){
      editingOriginalTitle=n.title;
      editTitle.value=n.title;
      editBody.value=n.content||'';
      editTags.value=tags.join(', ');
      editDlg.showModal();
    }

    editDlg.addEventListener('close',async()=>{
      if(editDlg.returnValue!=='ok') return;
      const newTitle=editTitle.value.trim();
      const newBody=editBody.value.trim();
      const newTags=editTags.value.split(',').map(t=>t.trim()).filter(Boolean);

      if(!newTitle||!newBody){ alert('Title and body required'); return; }

      try{
        await fetch(`${API_BASE}/notes/${encodeURIComponent(editingOriginalTitle)}`,{
          method:'PUT',headers:{'Content-Type':'application/json',Authorization:`Bearer ${sessionId}`},
          body:JSON.stringify({title:newTitle,content:newBody})
        });

        // update tags localStorage
        const tagMap=JSON.parse(localStorage.getItem(TAGS_KEY)||'{}');
        tagMap[newTitle]=newTags;
        localStorage.setItem(TAGS_KEY,JSON.stringify(tagMap));

        loadNotes();
      }catch(e){ alert(e.message||'Save failed'); }
    });

    async function delNote(title){
      if(!confirm(`Delete "${title}"?`)) return;
      await fetch(`${API_BASE}/notes/${encodeURIComponent(title)}`,{method:'DELETE',headers:{Authorization:`Bearer ${sessionId}`}});
      loadNotes();
    }

    searchEl.addEventListener('input',()=> render(searchEl.value.trim().toLowerCase()));
    loadNotes();
  </script>
</body>
</html>
